#!/usr/bin/env ruby
require 'htmlbeautifier'
require 'optparse'
require 'fileutils'

def beautify(name, input, output, options)
    beautifier = HtmlBeautifier::Beautifier.new(output)
    beautifier.tab_stops = options[:tabstop]
    beautifier.scan(input)
    output << "\n"
    rescue => e
        raise "Error parsing #{name}: #{e}"
end


options = {:tabstop => 2}
parser = OptionParser.new do |opts|
    opts.on("-t", "--tabs NUMBER", Integer) do |num|
        options[:tabstop] = num
    end
end

if ARGV.any?
    parser.parse!
    ARGV.each do |path|
        input = File.read(path)
        temppath = path + ".tmp"
        File.open(temppath, "w") do |output|
            beautify path, input, output, options
        end
        FileUtils.mv temppath, path
    end 
else
    puts parser
end
